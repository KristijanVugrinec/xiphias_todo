{% extends 'base.html.twig' %}

{% block title %}Todo List{% endblock %}

{% block body %}
    <h1>Todo List</h1>

    <a href="{{ path('todo_create') }}" class="btn btn-success">Create New Todo</a>

    <ul>
        {% for todo in todos %}
            <li>{{ todo.title }} - {{ todo.dueDate|date('Y-m-d H:i') }}</li>
            <p>{{todo.description}}</p>
            <button class="delete-todo-btn" data-id="{{todo.id}}">DELETE</button>
            <button class="is-finished-btn" data-id="{{todo.id}}" data-finished="{{todo.isFinished ? '1' : '0'}}" {% if todo.isFinished %}disabled{% endif %}>FINISHED</button>
        {% else %}
            <li>No todos yet!</li>
        {% endfor %}
    </ul>
    <a href="{{ path('app_logout') }}">Odjavite se</a>

    <script>
    document.addEventListener('DOMContentLoaded',() => {
        document.querySelectorAll('.delete-todo-btn').forEach(button => {
            button.addEventListener('click',()=>{
                const todoId = button.getAttribute('data-id');
                console.log("id od todo-a",todoId)

                fetch(`/todo/${todoId}/delete`,{
                    method:'DELETE',
                    headers:{
                        'X-Requested-With':'XMLHttpRequest'
                    },
                })

                .then(response => {
                    if(response.ok){
                        alert('Todo deleted successfully');
                        location.reload()
                    } else {
                        response.json().then(data => {
                            alert(data.message || 'An error occurred')
                        })
                    }
                })
                .catch(error => {
                    console.error('Error',error)
                    alert('An error occurred while deleting the todo.')
                })
            })
        })

        document.querySelectorAll('.is-finished-btn').forEach(button => {
            button.addEventListener('click',() => {
                const todoId = button.getAttribute('data-id');
                const isFinished = button.getAttribute('data-finished') === '1';

                fetch(`/todo/${todoId}/toggle-finished`,{
                    method:'POST',
                    headers:{
                        'X-Requested-With':'XMLHttpRequest',
                        'Content-Type':'application/json',
                    },
                    body:JSON.stringify({isFinished:!isFinished})
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success){
                        button.setAttribute('data-finished', '1'); // Ažuriraj status
                        button.disabled = true; // Onemogući dugme
                        console.log("success")
                    } else {
                        aler('An error occured while updating the task status.')
                    }
                })
                .catch(error => {
                    console.log('Error:',error)
                    alert('An error occurred while updating the task status.');
                })
            })
        })
    })
    </script>
{% endblock %}
